var labels={"In progress":"label-primary",Queued:"label-info",Completed:"label-success","Emails Sent":"label-success",Error:"label-danger"},campaigns=[],campaign={};function launch(){var e="",a=$("#name").val(),t=$("#template").val(),n=$("#page").val(),s=$("#profile").val(),o=$("#users").val(),i=$("#launch_date").val(),l=$("#send_by_date").val();if(a&&""!==a.trim())if(t&&""!==t)if(n&&""!==n)if(s&&""!==s)if(o&&0!==o.length)if(i&&""!==i.trim()){var r=moment(i,"MMMM Do YYYY, h:mm a"),c=moment();if(r.isBefore(c))e="Launch date cannot be in the past";else if(l&&""!==l.trim()){moment(l,"MMMM Do YYYY, h:mm a").isBefore(r)&&(e='The launch date must be before the "send emails by" date')}}else e="Launch date is required";else e="At least one group is required";else e="Email type is required";else e="Landing page is required";else e="Email template is required";else e="Campaign name is required";e?Swal.fire({title:"Validation Error",text:e,type:"error",confirmButtonColor:"#428bca"}):validateRateLimit(a,t,n,s,o,i,l,(function(e,a){e&&(a&&(l=a,$("#send_by_date").val(a)),Swal.fire({title:"Are you sure?",text:"This will schedule the campaign to be launched.",type:"question",animation:!1,showCancelButton:!0,confirmButtonText:"Launch",confirmButtonColor:"#428bca",reverseButtons:!0}).then((function(e){if(e.value){var a=!1,t=null;Swal.fire({title:"Launching Campaign...",html:'<div style="text-align: center;"><i class="fa fa-spinner fa-spin fa-3x"></i><br><br>Please wait while we schedule your campaign...</div>',allowOutsideClick:!0,allowEscapeKey:!0,allowEnterKey:!1,showConfirmButton:!1,showCancelButton:!0,cancelButtonText:"Cancel",cancelButtonColor:"#d33",onClose:function(){a=!0,t&&clearTimeout(t)}}),groups=[],$("#users").select2("data").forEach((function(e){groups.push({name:e.text})}));var n=$("#send_by_date").val();""!=n&&(n=moment(n,"MMMM Do YYYY, h:mm a").utc().format()),campaign={name:$("#name").val(),template:{name:$("#template").select2("data")[0].text},url:$("#url").val(),page:{name:$("#page").select2("data")[0].text},email_type:$("#profile").val(),launch_date:moment($("#launch_date").val(),"MMMM Do YYYY, h:mm a").utc().format(),send_by_date:n||null,groups:groups},t=setTimeout((function(){a||(a=!0,Swal.fire({title:"Request Timed Out",text:"The campaign launch is taking longer than expected. Please check if the email service is running and try again.",type:"error",confirmButtonColor:"#428bca"}))}),2e4),api.campaigns.post(campaign).success((function(e){t&&clearTimeout(t),a||(campaign=e,Swal.fire("Campaign Scheduled!","This campaign has been scheduled for launch!","success").then((function(){window.location="/campaigns/"+campaign.id.toString()})))})).error((function(e){if(t&&clearTimeout(t),!a){var n="An error occurred while launching the campaign";if(e.responseJSON)e.responseJSON.message?n=e.responseJSON.message:e.responseJSON.error?n=e.responseJSON.error:"string"==typeof e.responseJSON&&(n=e.responseJSON);else if(e.responseText)try{var s=JSON.parse(e.responseText);n=s.message||s.error||n}catch(a){e.responseText.length<200?n=e.responseText:e.statusText&&(n=e.statusText)}else e.statusText&&(n=e.statusText);e.status&&(n="[HTTP "+e.status+"] "+n),Swal.fire({title:"Launch Failed",text:n,type:"error",confirmButtonColor:"#428bca"})}}))}})))}))}function validateRateLimit(e,a,t,n,s,o,i,l){var r=[];$("#users").select2("data").forEach((function(e){r.push(parseInt(e.id))}));var c=moment(o,"MMMM Do YYYY, h:mm a").utc().format(),m=i&&""!==i.trim()?moment(i,"MMMM Do YYYY, h:mm a").utc().format():"";$.ajax({url:"/api/campaigns/validate-rate-limit",method:"POST",data:JSON.stringify({launch_date:c,send_by_date:m||null,group_ids:r}),contentType:"application/json",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)}}).done((function(e){e.success?l(!0,null):e.warning?showRateLimitWarning(e.warning,(function(a,t){if(a)if(t){var n=moment(e.warning.minimum_send_by_date).format("MMMM Do YYYY, h:mm a");l(!0,n)}else l(!0,null);else l(!1,null)})):l(!0,null)})).fail((function(e,a,t){console.error("Rate limit validation failed:",t),l(!0,null)}))}function showRateLimitWarning(e,a){var t=`\n        <div style="text-align: left; margin-bottom: 20px;">\n            <p><strong>‚ö†Ô∏è Your campaign will send emails too quickly!</strong></p>\n            <p>${e.warning_message}</p>\n            <hr>\n            <p><strong>Your Settings:</strong></p>\n            <ul>\n                <li>Sending to: <strong>${e.total_recipients}</strong> recipients</li>\n                <li>Interval: <strong>${e.provided_interval_seconds.toFixed(1)}</strong> seconds per recipient</li>\n                <li>Send-by date: <strong>${moment(e.provided_send_by_date).format("MMMM Do YYYY, h:mm a")}</strong></li>\n            </ul>\n            <hr>\n            <p><strong>Recommended Safe Settings:</strong></p>\n            <ul>\n                <li>Interval: <strong>${e.minimum_interval_seconds}</strong> seconds per recipient (${(e.minimum_interval_seconds/60).toFixed(1)} minutes)</li>\n                <li>Send-by date: <strong>${moment(e.minimum_send_by_date).format("MMMM Do YYYY, h:mm a")}</strong></li>\n                <li>Total duration: <strong>${e.recommended_duration}</strong></li>\n            </ul>\n        </div>\n    `;Swal.fire({title:"‚ö†Ô∏è Rate Limit Warning",html:t,type:"warning",showCancelButton:!0,showDenyButton:!0,confirmButtonText:"Use Safe Settings",denyButtonText:"Keep My Settings (Risky)",cancelButtonText:"Cancel",confirmButtonColor:"#28a745",denyButtonColor:"#ffc107",cancelButtonColor:"#6c757d",reverseButtons:!0}).then((function(e){e.value?a(!0,!0):e.isDenied?a(!0,!1):a(!1,!1)}))}function sendTestEmail(){try{console.log("sendTestEmail() called"),$("#sendTestEmailModal\\.flashes").empty();var e=$("#profile").val();if(console.log("Email type:",e),!e||""===e)return console.log("No email type selected"),void $("#sendTestEmailModal\\.flashes").append('<div style="text-align:center" class="alert alert-danger">                <i class="fa fa-exclamation-circle"></i> Please select an email type</div>');var a="";try{var t=$("#template").select2("data");t&&t.length>0&&(a=t[0].text)}catch(e){console.log("Could not get template from select2, using empty string (will use default)")}console.log("Template name:",a);var n="";try{var s=$("#page").select2("data");s&&s.length>0&&(n=s[0].text)}catch(e){console.log("Could not get page from select2, using empty string")}console.log("Page name:",n);var o={template:{name:a},first_name:$("input[name=to_first_name]").val(),last_name:$("input[name=to_last_name]").val(),email:$("input[name=to_email]").val(),position:$("input[name=to_position]").val(),url:$("#url").val(),page:{name:n},email_type:e};console.log("Test email request:",o),btnHtml=$("#sendTestModalSubmit").html(),$("#sendTestModalSubmit").html('<i class="fa fa-spinner fa-spin"></i> Sending'),console.log("Calling api.send_test_email()"),api.send_test_email(o).success((function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-success">            <i class="fa fa-check-circle"></i> Email Sent!</div>'),$("#sendTestModalSubmit").html(btnHtml)})).error((function(e){$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>"),$("#sendTestModalSubmit").html(btnHtml)}))}catch(e){console.error("Error in sendTestEmail():",e),$("#sendTestEmailModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> Error: '+e.message+"</div>"),"undefined"!=typeof btnHtml&&$("#sendTestModalSubmit").html(btnHtml)}}function dismiss(){$("#modal\\.flashes").empty(),$("#name").val(""),$("#template").val("").change(),$("#page").val("").change(),$("#url").val(""),$("#profile").val("").change(),$("#users").val("").change(),$("#modal").modal("hide")}function deleteCampaign(e){Swal.fire({title:"Are you sure?",text:"This will delete the campaign. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+campaigns[e].name,confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,t){api.campaignId.delete(campaigns[e].id).success((function(e){a()})).error((function(e){t(e.responseJSON.message)}))}))}}).then((function(e){e.value&&Swal.fire("Campaign Deleted!","This campaign has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))}function setLaunchDateToNowPlusFiveMinutes(){var e=moment().add(5,"minutes");$("#launch_date").data("DateTimePicker").date(e),console.log("Auto-set launch date to:",e.format("MMMM Do YYYY, h:mm a"))}function setupOptions(){api.groups.summary().success((function(e){groups=e.groups;var a=$.map(groups,(function(e){return e.text=e.name,e.title=e.num_targets+" targets",e}));if($("#users.form-control").select2({placeholder:"Select Groups",data:a,dropdownParent:$("body")}),0==groups.length)return modalError("No groups found!"),!1})),api.templates.get().success((function(e){if(0==e.length)return modalError("No templates found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#template.form-control");t.select2({placeholder:"Select a Template",data:a}),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))})),api.pages.get().success((function(e){if(0==e.length)return modalError("No pages found!"),!1;var a=$.map(e,(function(e){return e.text=e.name,e})),t=$("#page.form-control");t.select2({placeholder:"Select a Landing Page",data:a}),1===e.length&&(t.val(a[0].id),t.trigger("change.select2"))})),api.email_types.get().success((function(e){if(0==e.length)return modalError("No email types found!"),!1;var a=$.map(e,(function(e){return e.text=e.display_name,e.id=e.value,e})),t=$("#profile");t.select2({placeholder:"Select an Email Type",data:a,dropdownParent:$("#modal")}),t.val(a[0].id).trigger("change"),t.on("change",(function(){setLaunchDateToNowPlusFiveMinutes()})),setLaunchDateToNowPlusFiveMinutes()}))}function edit(e){setupOptions()}function copy(e){setupOptions(),api.campaignId.get(campaigns[e].id).success((function(e){$("#name").val("Copy of "+e.name),e.template.id?($("#template").val(e.template.id.toString()),$("#template").trigger("change.select2")):($("#template").val("").change(),$("#template").select2({placeholder:e.template.name})),e.page.id?($("#page").val(e.page.id.toString()),$("#page").trigger("change.select2")):($("#page").val("").change(),$("#page").select2({placeholder:e.page.name})),e.email_type&&($("#profile").val(e.email_type),$("#profile").trigger("change.select2")),$("#url").val(e.url)})).error((function(e){$("#modal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+e.responseJSON.message+"</div>")}))}var currentCampaignMode="copilot",chatHistory=[];function switchCampaignMode(e){currentCampaignMode=e;var a=$("#modal").find(".modal-dialog");a.addClass("morphing"),a.removeClass("mode-manual mode-copilot mode-auto"),a.addClass("mode-"+e),$(".mode-toggle-btn").removeClass("active"),$('[data-mode="'+e+'"]').addClass("active"),"copilot"===e?($(".info-badge").removeClass("auto-mode").addClass("copilot-mode"),$(".info-badge i").attr("class","fa fa-magic"),$("#chat-mode-text").text("Copilot Mode - AI assists you in creating the campaign")):"auto"===e&&($(".info-badge").removeClass("copilot-mode").addClass("auto-mode"),$(".info-badge i").attr("class","fa fa-rocket"),$("#chat-mode-text").text("Auto Mode - AI creates the campaign automatically")),"manual"===e?($("#ai-chat-interface").fadeOut(300,(function(){$("#manual-form-interface").fadeIn(300)})),$("#template").hasClass("select2-hidden-accessible")||setupOptions()):$("#manual-form-interface").fadeOut(300,(function(){$("#ai-chat-interface").fadeIn(300,(function(){"function"==typeof window.initN8nChat&&window.initN8nChat(e)}))})),setTimeout((function(){a.removeClass("morphing")}),500)}function resetChatInterface(){chatHistory=[],$("#chatMessages").html('\n        <div class="chat-message ai-message">\n            <div class="message-avatar">\n                <i class="fa fa-robot"></i>\n            </div>\n            <div class="message-content">\n                <p><strong>FYPhish AI Assistant</strong></p>\n                <p>Hello! I\'m here to help you create an effective phishing campaign. Let\'s start by understanding your goals.</p>\n                <p>What type of campaign would you like to create?</p>\n                <div class="quick-suggestions">\n                    <button class="suggestion-btn" onclick="sendQuickReply(\'Credential harvesting campaign\')">\n                        <i class="fa fa-key"></i> Credential Harvesting\n                    </button>\n                    <button class="suggestion-btn" onclick="sendQuickReply(\'Link clicking awareness\')">\n                        <i class="fa fa-link"></i> Link Awareness\n                    </button>\n                    <button class="suggestion-btn" onclick="sendQuickReply(\'Attachment awareness\')">\n                        <i class="fa fa-paperclip"></i> Attachment Awareness\n                    </button>\n                    <button class="suggestion-btn" onclick="sendQuickReply(\'Custom campaign\')">\n                        <i class="fa fa-cog"></i> Custom\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),$("#campaignPreview").hide()}function sendChatMessage(){var e=$("#chatInput").val().trim();e&&(addChatMessage("user",e),$("#chatInput").val(""),showTypingIndicator(),startAutopilotWorkflow(e))}function sendQuickReply(e){$("#chatInput").val(e),sendChatMessage()}function addChatMessage(e,a){var t="user"===e,n=`\n        <div class="chat-message ${t?"user-message":"ai-message"}">\n            <div class="message-avatar">\n                <i class="fa ${t?"fa-user":"fa-robot"}"></i>\n            </div>\n            <div class="message-content">\n                <p>${escapeHtml(a)}</p>\n            </div>\n        </div>\n    `;$("#chatMessages").append(n),scrollChatToBottom(),chatHistory.push({sender:e,message:a})}function showTypingIndicator(){$("#chatMessages").append('\n        <div class="chat-message ai-message typing-message">\n            <div class="message-avatar">\n                <i class="fa fa-robot"></i>\n            </div>\n            <div class="message-content">\n                <div class="typing-indicator">\n                    <div class="typing-dot"></div>\n                    <div class="typing-dot"></div>\n                    <div class="typing-dot"></div>\n                </div>\n            </div>\n        </div>\n    '),scrollChatToBottom()}function hideTypingIndicator(){$(".typing-message").remove()}function scrollChatToBottom(){var e=$("#chatMessages");e.scrollTop(e[0].scrollHeight)}var autopilotState={userPrompt:"",emailType:null,emailTypeName:"",groupId:null,groupName:"",targetCount:0,templateId:null,templateName:"",pageId:null,pageName:"",aiGenerated:!1};function startAutopilotWorkflow(e){autopilotState={userPrompt:e,emailType:null,emailTypeName:"",groupId:null,groupName:"",targetCount:0,templateId:null,templateName:"",pageId:null,pageName:"",aiGenerated:!1},callAutopilotAgent1(e)}function callAutopilotAgent1(e){appendAIMessage('<i class="fa fa-cog fa-spin"></i> Analyzing email type from your request...'),$.ajax({url:"/api/campaigns/ai-workflow/1",method:"POST",data:JSON.stringify({user_prompt:e}),contentType:"application/json",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)}}).done((function(a){if(hideTypingIndicator(),a.success){autopilotState.emailType=a.matched_type,autopilotState.emailTypeName=a.email_type_name;var t="‚úì Email Type Identified: <strong>"+escapeHtml(a.email_type_name)+"</strong><br>";t+='<small class="text-muted">Confidence: '+a.confidence+"%</small><br>",appendAIMessage(t+='<small class="text-muted">'+escapeHtml(a.reasoning)+"</small>"),showTypingIndicator(),setTimeout((function(){callAutopilotAgent2(e)}),500)}else appendAIMessage('<span class="text-danger">‚úó Failed to identify email type: '+escapeHtml(a.error)+"</span>")})).fail((function(e,a,t){hideTypingIndicator();var n=e.responseJSON&&e.responseJSON.error?e.responseJSON.error:t;appendAIMessage('<span class="text-danger">‚úó Error calling AI Workflow 1: '+escapeHtml(n)+"</span>")}))}function callAutopilotAgent2(e){appendAIMessage('<i class="fa fa-cog fa-spin"></i> Filtering targets and creating group...'),$.ajax({url:"/api/campaigns/ai-workflow/2",method:"POST",data:JSON.stringify({user_prompt:e}),contentType:"application/json",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)}}).done((function(a){if(hideTypingIndicator(),a.success){autopilotState.groupId=a.group_id,autopilotState.groupName=a.group_name,autopilotState.targetCount=a.target_count;var t="‚úì Target Group Created: <strong>"+escapeHtml(a.group_name)+"</strong><br>";t+='<small class="text-muted">Targets: '+a.target_count+" recipients</small><br>",appendAIMessage(t+='<small class="text-muted">'+escapeHtml(a.filter_description)+"</small>"),showTypingIndicator(),setTimeout((function(){callAutopilotAgent3(e,autopilotState.emailType)}),500)}else appendAIMessage('<span class="text-danger">‚úó Failed to create target group: '+escapeHtml(a.error)+"</span>")})).fail((function(e,a,t){hideTypingIndicator();var n=e.responseJSON&&e.responseJSON.error?e.responseJSON.error:t;appendAIMessage('<span class="text-danger">‚úó Error calling AI Workflow 2: '+escapeHtml(n)+"</span>")}))}function callAutopilotAgent3(e,a){appendAIMessage('<i class="fa fa-cog fa-spin"></i> Preparing email template and landing page...'),$.ajax({url:"/api/campaigns/ai-workflow/3",method:"POST",data:JSON.stringify({user_prompt:e,theme_description:e,email_type:a}),contentType:"application/json",dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+user.api_key)}}).done((function(e){if(hideTypingIndicator(),e.success){autopilotState.templateId=e.template_id,autopilotState.templateName=e.template_name,autopilotState.pageId=e.page_id,autopilotState.pageName=e.page_name,autopilotState.aiGenerated=e.ai_generated;var a="‚úì Template & Landing Page Ready<br>";a+='<small class="text-muted">Template: '+escapeHtml(e.template_name)+"</small><br>",a+='<small class="text-muted">Landing Page: '+escapeHtml(e.page_name)+"</small>",e.ai_generated&&e.warning&&(a+='<br><span class="text-warning"><i class="fa fa-exclamation-triangle"></i> '+escapeHtml(e.warning)+"</span>"),appendAIMessage(a),setTimeout((function(){showAutopilotCampaignPreview()}),500)}else appendAIMessage('<span class="text-danger">‚úó Failed to generate template/page: '+escapeHtml(e.error)+"</span>")})).fail((function(e,a,t){hideTypingIndicator();var n=e.responseJSON&&e.responseJSON.error?e.responseJSON.error:t;appendAIMessage('<span class="text-danger">‚úó Error calling AI Workflow 3: '+escapeHtml(n)+"</span>")}))}function appendAIMessage(e){var a=`\n        <div class="chat-message ai-message">\n            <div class="message-avatar">\n                <i class="fa fa-robot"></i>\n            </div>\n            <div class="message-content">\n                <p>${e}</p>\n            </div>\n        </div>\n    `;$("#chatMessages").append(a),scrollChatToBottom()}function showAutopilotCampaignPreview(){var e="AI Campaign - "+moment().format("YYYY-MM-DD HH:mm"),a=moment().add(5,"minutes").format("MMMM Do YYYY, h:mm a");$("#name").val(e),$("#template").val(autopilotState.templateId.toString()).trigger("change.select2"),$("#page").val(autopilotState.pageId.toString()).trigger("change.select2"),$("#profile").val(autopilotState.emailType).trigger("change.select2"),$("#users").val([autopilotState.groupId.toString()]).trigger("change.select2"),$("#launch_date").val(a);var t=`\n        <div class="row">\n            <div class="col-md-6">\n                <p><strong>Campaign Name:</strong><br>${escapeHtml(e)}</p>\n                <p><strong>Email Type:</strong><br>${escapeHtml(autopilotState.emailTypeName)}</p>\n                <p><strong>Email Template:</strong><br>${escapeHtml(autopilotState.templateName)}${autopilotState.aiGenerated?' <span class="label label-info">AI Generated</span>':""}</p>\n            </div>\n            <div class="col-md-6">\n                <p><strong>Landing Page:</strong><br>${escapeHtml(autopilotState.pageName)}${autopilotState.aiGenerated?' <span class="label label-info">AI Generated</span>':""}</p>\n                <p><strong>Target Group:</strong><br>${escapeHtml(autopilotState.groupName)} (${autopilotState.targetCount} recipients)</p>\n                <p><strong>Launch Date:</strong><br>${escapeHtml(a)}</p>\n            </div>\n        </div>\n    `;$("#previewContent").html(t),$("#campaignPreview").slideDown(),appendAIMessage('üéØ <strong>Campaign Ready!</strong> Review the details above and click "Launch Campaign" when ready, or "Edit Details" to make changes.')}function showCampaignPreview(e){var a=`\n        <div class="row">\n            <div class="col-md-6">\n                <p><strong>Campaign Name:</strong><br>${escapeHtml(e.name)}</p>\n                <p><strong>Type:</strong><br>${escapeHtml(e.type)}</p>\n                <p><strong>Email Template:</strong><br>${escapeHtml(e.template)}</p>\n            </div>\n            <div class="col-md-6">\n                <p><strong>Landing Page:</strong><br>${escapeHtml(e.landingPage)}</p>\n                <p><strong>Target Groups:</strong><br>${escapeHtml(e.targetGroups)}</p>\n                <p><strong>Launch Date:</strong><br>${escapeHtml(e.launchDate)}</p>\n            </div>\n        </div>\n    `;$("#previewContent").html(a),$("#campaignPreview").slideDown(),switchToManualFormSilently(e)}function switchToManualFormSilently(e){$("#name").val(e.name)}function editCampaignDetails(){switchCampaignMode("manual")}$(document).on("keydown","#chatInput",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendChatMessage())})),$(document).ready((function(){$(".mode-toggle-btn").on("click",(function(){switchCampaignMode($(this).data("mode"))})),$("#modal .modal-dialog").addClass("mode-copilot"),$("#sendTestEmailModal").on("hidden.bs.modal",(function(){$("#sendTestEmailModal\\.flashes").empty()})),switchCampaignMode("copilot"),$("#launch_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,defaultDate:moment(),format:"MMMM Do YYYY, h:mm a"}),$("#send_by_date").datetimepicker({widgetPositioning:{vertical:"bottom"},showTodayButton:!0,useCurrent:!1,format:"MMMM Do YYYY, h:mm a"}),$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),$("#modal").on("shown.bs.modal",(function(){"manual"!==currentCampaignMode&&"function"==typeof window.initN8nChat&&setTimeout((function(){window.initN8nChat(currentCampaignMode)}),100)})),api.campaigns.summary().success((function(e){campaigns=e.campaigns,$("#loading").hide(),campaigns.length>0?($("#campaignTable").show(),$("#campaignTableArchive").show(),activeCampaignsTable=$("#campaignTable").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),archivedCampaignsTable=$("#campaignTableArchive").DataTable({columnDefs:[{orderable:!1,targets:"no-sort"}],order:[[1,"desc"]]}),rows={active:[],archived:[]},$.each(campaigns,(function(e,a){if(label=labels[a.status]||"label-default",moment(a.launch_date).isAfter(moment()))var t="Scheduled to start: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+a.stats.total;else t="Launch Date: "+moment(a.launch_date).format("MMMM Do YYYY, h:mm:ss a")+"<br><br>Number of recipients: "+a.stats.total+"<br><br>Emails opened: "+a.stats.opened+"<br><br>Emails clicked: "+a.stats.clicked+"<br><br>Submitted Credentials: "+a.stats.submitted_data+"<br><br>Errors : "+a.stats.error+"<br><br>Reported : "+a.stats.email_reported;var n=[escapeHtml(a.name),moment(a.created_date).format("MMMM Do YYYY, h:mm:ss a"),'<span class="label '+label+'" data-toggle="tooltip" data-placement="right" data-html="true" title="'+t+'">'+a.status+"</span>","<div class='pull-right'><a class='btn btn-primary' href='/campaigns/"+a.id+"' data-toggle='tooltip' data-placement='left' title='View Results'>                    <i class='fa fa-bar-chart'></i>                    </a>            <span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Campaign' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' onclick='deleteCampaign("+e+")' data-toggle='tooltip' data-placement='left' title='Delete Campaign'>                    <i class='fa fa-trash-o'></i>                    </button></div>"];"Completed"==a.status?rows.archived.push(n):rows.active.push(n)})),activeCampaignsTable.rows.add(rows.active).draw(),archivedCampaignsTable.rows.add(rows.archived).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).error((function(){$("#loading").hide(),errorFlash("Error fetching campaigns")})),$.fn.select2.defaults.set("width","100%"),$.fn.select2.defaults.set("dropdownParent",$("#modal_body")),$.fn.select2.defaults.set("theme","bootstrap"),$.fn.select2.defaults.set("sorter",(function(e){return e.sort((function(e,a){return e.text.toLowerCase()>a.text.toLowerCase()?1:e.text.toLowerCase()<a.text.toLowerCase()?-1:0}))}))}));