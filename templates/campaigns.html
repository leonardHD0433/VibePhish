{{define "body"}}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="row">
        <h1 class="page-header">
            Campaigns
        </h1>
    </div>
    <div id="flashes" class="row"></div>
    <div class="row">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-backdrop="static" data-target="#modal"
            onclick="edit('new')">
            <i class="fa fa-plus"></i> New Campaign</button>
    </div>
    &nbsp;

    <ul class="nav nav-tabs" role="tablist">
        <li class="active" role="activeCampaigns"><a href="#activeCampaigns" aria-controls="activeCampaigns" role="tab"
                data-toggle="tab">Active Campaigns</a></li>
        <li role="archivedCampaigns"><a href="#archivedCampaigns" aria-controls="archivedCampaigns" role="tab"
                data-toggle="tab">Archived Campaigns</a></li>
    </ul>
    </br>
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="activeCampaigns">
            <div id="flashes" class="row"></div>
            &nbsp;
            <div id="loading">
                <i class="fa fa-spinner fa-spin fa-4x"></i>
            </div>
            <div id="emptyMessage" class="row" style="display:none;">
                <div class="alert alert-info">
                    No campaigns created yet. Let's create one!
                </div>
            </div>
            <div class="row">
                <table id="campaignTable" class="table" style="display:none;">
                    <thead>
                        <tr>
                            <th class="col-md-3">Name</th>
                            <th class="col-md-4">Created Date</th>
                            <th class="col-md-2">Status</th>
                            <th class="col-md-3 no-sort"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="archivedCampaigns">
            </br>
            <div id="emptyMessage" class="row" style="display:none;">
                </br>
                <div class="alert alert-info">
                    No archived campaigns.
                </div>
            </div>
            <div class="row">
                <table id="campaignTableArchive" class="table" style="display:none;">
                    <thead>
                        <tr>
                            <th class="col-md-3">Name</th>
                            <th class="col-md-4">Created Date</th>
                            <th class="col-md-2">Status</th>
                            <th class="col-md-3 no-sort"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg campaign-modal" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="dismiss()">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="campaignModalLabel">New Campaign</h4>
            </div>
            <div class="modal-body" id="modal_body">
                <div class="row" id="modal.flashes"></div>

                <!-- Campaign Creation Mode Toggle -->
                <div class="campaign-mode-toggle-wrapper">
                    <div class="campaign-mode-toggle">
                        <button type="button" class="mode-toggle-btn" data-mode="manual">
                            <i class="fa fa-edit"></i>
                            <span>Manual</span>
                        </button>
                        <button type="button" class="mode-toggle-btn active" data-mode="copilot">
                            <i class="fa fa-magic"></i>
                            <span>Copilot</span>
                        </button>
                        <!-- Auto mode - TODO: Implement fully automated campaign creation
                        <button type="button" class="mode-toggle-btn" data-mode="auto">
                            <i class="fa fa-rocket"></i>
                            <span>Auto</span>
                        </button>
                        -->
                    </div>
                </div>

                <!-- AI Chatbox Interface (Copilot mode) -->
                <div id="ai-chat-interface" class="ai-chat-interface">
                    <div class="chat-mode-info">
                        <div class="info-badge copilot-mode">
                            <i class="fa fa-magic"></i>
                            <span id="chat-mode-text">Copilot Mode - AI assists you in creating the campaign</span>
                        </div>
                    </div>

                    <!-- n8n Chat Widget Container -->
                    <div id="n8n-chat-container" class="n8n-chat-wrapper"></div>

                    <!-- Campaign Preview (shown after AI collects all info) -->
                    <div class="campaign-preview" id="campaignPreview" style="display: none;">
                        <div class="preview-header">
                            <h5><i class="fa fa-eye"></i> Campaign Preview</h5>
                            <button class="btn btn-sm btn-default" onclick="editCampaignDetails()">
                                <i class="fa fa-edit"></i> Edit Details
                            </button>
                        </div>
                        <div class="preview-content" id="previewContent">
                            <!-- Preview will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Manual Form (Original form) -->
                <div id="manual-form-interface" class="manual-form-interface" style="display: none;">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" class="form-control" id="name" placeholder="Campaign name" autofocus>
                        <label class="control-label" for="template">Email Template:</label>
                        <select class="form-control" placeholder="Template Name" id="template" />
                        <option></option>
                        </select>
                        <label class="control-label" for="page">Landing Page:</label>
                        <select class="form-control" placeholder="Landing Page" id="page" />
                        <option></option>
                        </select>
                        <!-- URL field hidden - n8n integration handles this automatically via PUBLIC_BASE_URL
                        <label class="control-label" for="url">URL:
                            <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="Location of Gophish listener (must be reachable by targets!)"></i>
                        </label>
                        <input type="text" class="form-control" placeholder="http://192.168.1.1" id="url" />
                        -->
                        <div class="row">
                            <div class="col-md-6">
                                <label class="control-label" for="url">Launch Date </label>
                                <input type="text" class="form-control" id="launch_date" />
                            </div>
                            <div class="col-md-6">
                                <label class="control-label" for="delay">Send Emails By (Optional)
                                    <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="right" title="If specified, Gophish will send emails evenly between the campaign launch and this date."></i>
                                </label>
                                <input type="text" class="form-control" id="send_by_date" autocomplete="random-data"/> <!--Chrome ignores autocomplete="off".-->
                            </div>
                        </div>
                        <label class="control-label" for="profile">Email Type:</label>
                        <div class="input-group">
                            <select class="form-control" placeholder="Email Type" id="profile" />
                            <option></option>
                            </select>
                            <span class="input-group-btn">
                                <button type="button" data-toggle="modal" data-backdrop="static" data-target="#sendTestEmailModal"
                                    class="btn btn-primary button">
                                    <i class="fa fa-envelope"></i> Send Test Email</button>
                            </span>
                        </div>
                        <label class="control-label" for="users">Groups:</label>
                        <select class="form-control" id="users" multiple="multiple"></select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="dismiss()">Close</button>
                <button type="button" id="launchButton" class="btn btn-primary" onclick="launch()">
                    <i class="fa fa-rocket"></i> Launch Campaign</button>
            </div>
        </div>
    </div>
</div>
<!-- Send Test Email Modal -->
<div class="modal" id="sendTestEmailModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <!-- New Email Modal -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="sendTestEmailModalTitle">Send Test Email</h4>
            </div>
            <div class="modal-body">
                <div class="row" id="sendTestEmailModal.flashes"></div>
                <div class="row">
                    <div class="col-sm-12">
                        <label class="control-label" for="to">Send Test Email to:</label>
                    </div>
                    <br>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" placeholder="First Name" name="to_first_name">
                    </div>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" placeholder="Last Name" name="to_last_name">
                    </div>
                    <div class="col-sm-4">
                        <input type="email" class="form-control" placeholder="Email" name="to_email" required>
                    </div>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" placeholder="Position" name="to_position">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendTestModalSubmit" onclick="sendTestEmail()">
                    <i class="fa fa-envelope"></i> Send</button>
            </div>
        </div>
    </div>
</div>
{{end}} {{define "scripts"}}
<!-- n8n Chat Widget -->
<link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
<script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    // Wait for DOM and campaigns.js to load
    window.addEventListener('load', function() {
        // Initialize n8n chat when switching to copilot/auto mode
        window.initN8nChat = function(mode) {
            const container = document.getElementById('n8n-chat-container');
            if (!container) return;

            // Clear any existing chat
            container.innerHTML = '';

            // Create unique session ID for this campaign creation session
            const sessionId = 'campaign-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            // Store session ID for later use
            window.currentChatSessionId = sessionId;

            // Initial message for Copilot mode
            // TODO: Add auto mode message when implementing fully automated campaign creation
            // const autoMessage = "Hi! I'm your AI campaign assistant in **Auto Mode**. Give me a minimum a phishing scenario you would like to simulate (e.g., password reset, invoice payment, account verification) and let me handle the rest. Let's get started!";
            const initialMessage = "Hi! I'm your AI campaign assistant. I'll help you create a phishing campaign step by step. What would you like to do today (Google password reset, invoice payment, account verification)?";

            // Get n8n chat config from server-side template variables
            const n8nChatUrl = '{{.N8nChatURL}}';
            const n8nChatUser = '{{.N8nChatUser}}';
            const n8nChatPassword = '{{.N8nChatPassword}}';
            const apiBaseUrl = '{{.ApiBaseURL}}';

            if (!n8nChatUrl) {
                console.warn('N8N_CHAT_WEBHOOK_URL not configured');
                container.innerHTML = '<div class="alert alert-warning">AI Chat not configured. Please set N8N_CHAT_WEBHOOK_URL in environment.</div>';
                return;
            }

            createChat({
                webhookUrl: n8nChatUrl,
                webhookConfig: {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa(n8nChatUser + ':' + n8nChatPassword)
                    }
                },
                target: '#n8n-chat-container',
                mode: 'fullscreen',
                chatInputKey: 'chatInput',
                chatSessionKey: 'sessionId',
                metadata: {
                    user_id: user.api_key ? 2 : 1,
                    mode: mode,
                    api_base_url: apiBaseUrl  // FYPHISH_API_BASE_URL from .env (port 3333)
                },
                initialMessages: [initialMessage],
                i18n: {
                    en: {
                        title: 'Campaign Assistant',
                        // TODO: Add auto mode subtitle when implementing: mode === 'auto' ? 'Auto Mode - Fully automated campaign creation' : ...
                        subtitle: 'Copilot Mode - AI-assisted campaign creation',
                        footer: '',
                        getStarted: 'Start Creating',
                        inputPlaceholder: 'Type your message...',
                        closeButtonTooltip: 'Close chat'
                    }
                },
                showWelcomeScreen: false,
                allowFileUploads: false
            });
        };
    });
</script>
<style>
    /* n8n Chat Custom Styling for FYPhish - Matching System Theme */
    .n8n-chat-wrapper {
        /* Primary Colors - Match FYPhish dark navy theme */
        --chat--color--primary: #2c3e50;
        --chat--color--primary-shade-50: #34495e;
        --chat--color--primary-shade-100: #1a252f;
        --chat--color--secondary: #1abc9c;
        --chat--color--secondary-shade-50: #16a085;
        --chat--color--white: #ffffff;
        --chat--color--light: #f8f9fa;
        --chat--color--light-shade-50: #e9ecef;
        --chat--color--light-shade-100: #dee2e6;
        --chat--color--medium: #6c757d;
        --chat--color--dark: #2c3e50;
        --chat--color--disabled: #adb5bd;
        --chat--color--typing: #6c757d;

        /* Sizing - Fit within modal */
        --chat--window--width: 100%;
        --chat--window--height: 100%;

        /* Messages */
        --chat--message--font-size: 14px;
        --chat--message--border-radius: 12px;
        --chat--message--padding: 10px 14px;

        /* Input */
        --chat--input--background: var(--chat--color--white);
        --chat--input--border-radius: 8px;
        --chat--input--font-size: 14px;
        --chat--input--placeholder-color: #adb5bd;

        /* Container */
        --chat--border-radius: 8px;
        --chat--transition-duration: 0.2s;

        /* Chat container sizing - clean design */
        width: 100%;
        height: 500px;
        min-height: 500px;
        max-height: 500px;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        /* Subtle border matching system theme */
        border: 1px solid #dee2e6;
        background: #f8f9fa;
    }

    /* Override n8n chat fullscreen mode to fit in modal */
    .n8n-chat-wrapper .chat-wrapper,
    .n8n-chat-wrapper > div {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        max-height: 500px !important;
        display: flex !important;
        flex-direction: column !important;
        inset: unset !important;
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
    }

    /* Chat window container - the main window, no extra borders */
    .n8n-chat-wrapper .chat-window,
    .n8n-chat-wrapper [class*="chat-window"] {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        max-height: 500px !important;
        display: flex !important;
        flex-direction: column !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* Chat body (messages + input) */
    .n8n-chat-wrapper .chat-body {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 1 auto !important;
        min-height: 0 !important;
        overflow: hidden !important;
        height: 100% !important;
    }

    /* Style the chat messages area - enable scrolling */
    .n8n-chat-wrapper .chat-messages-container,
    .n8n-chat-wrapper .chat-messages,
    .n8n-chat-wrapper [class*="chat-messages"] {
        background-color: #f8f9fa !important;
        padding: 16px !important;
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        min-height: 0 !important;
        max-height: none !important;
        height: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }

    /* Ensure the messages list scrolls */
    .n8n-chat-wrapper .chat-messages-list,
    .n8n-chat-wrapper [class*="messages-list"] {
        overflow-y: auto !important;
        flex: 1 1 auto !important;
        min-height: 0 !important;
    }

    /* Bot message styling */
    .n8n-chat-wrapper .chat-message-bot .chat-message-content,
    .n8n-chat-wrapper [class*="message-bot"],
    .n8n-chat-wrapper [class*="message-from-bot"] {
        background: #ffffff !important;
        color: #2c3e50 !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 12px !important;
        padding: 10px 14px !important;
    }

    /* Bot message avatar styling */
    .n8n-chat-wrapper .chat-message-bot .chat-message-avatar,
    .n8n-chat-wrapper [class*="avatar"] {
        background: #2c3e50 !important;
    }

    /* User message styling - dark navy theme */
    .n8n-chat-wrapper .chat-message-user .chat-message-content,
    .n8n-chat-wrapper [class*="message-user"],
    .n8n-chat-wrapper [class*="chat-message-from-user"],
    .n8n-chat-wrapper [class*="message-from-user"] {
        background: #2c3e50 !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 10px 14px !important;
        border: none !important;
    }

    /* User message text color */
    .n8n-chat-wrapper .chat-message-user .chat-message-content *,
    .n8n-chat-wrapper [class*="message-user"] *,
    .n8n-chat-wrapper [class*="chat-message-from-user"] *,
    .n8n-chat-wrapper [class*="message-from-user"] * {
        color: white !important;
    }

    /* User message bubble wrapper */
    .n8n-chat-wrapper .chat-message-user,
    .n8n-chat-wrapper [class*="chat-message"][class*="user"] {
        justify-content: flex-end !important;
    }

    /* REMOVE ALL BORDERS from everything inside the wrapper */
    .n8n-chat-wrapper *,
    .n8n-chat-wrapper *::before,
    .n8n-chat-wrapper *::after {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }

    /* Input area styling - compact footer */
    .n8n-chat-wrapper .chat-input-container,
    .n8n-chat-wrapper .chat-footer,
    .n8n-chat-wrapper [class*="chat-footer"],
    .n8n-chat-wrapper [class*="chat_footer"] {
        background: #ffffff !important;
        padding: 8px 12px !important;
        flex-shrink: 0 !important;
        border-radius: 0 !important;
        min-height: 70px !important;
        height: auto !important;
    }

    .n8n-chat-wrapper [class*="input"] {
        background: #ffffff !important;
        padding: 0 !important;
        border-radius: 0 !important;
    }

    /* Only the actual textarea/input should have visible border */
    .n8n-chat-wrapper textarea,
    .n8n-chat-wrapper input[type="text"] {
        border: 1px solid #ced4da !important;
        border-radius: 6px !important;
        padding: 10px 14px !important;
        font-size: 14px !important;
        background: white !important;
        margin-right: 10px !important;
        flex: 1 !important;
    }

    .n8n-chat-wrapper textarea:focus,
    .n8n-chat-wrapper input[type="text"]:focus {
        border-color: #2c3e50 !important;
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.15) !important;
    }

    /* Send button styling - match system theme */
    .n8n-chat-wrapper .chat-send-button,
    .n8n-chat-wrapper [class*="send-button"],
    .n8n-chat-wrapper button[type="submit"] {
        background: #2c3e50 !important;
        border-radius: 6px !important;
        width: 38px !important;
        height: 38px !important;
        transition: background 0.15s ease !important;
        border: none !important;
    }

    .n8n-chat-wrapper .chat-send-button:hover,
    .n8n-chat-wrapper [class*="send-button"]:hover,
    .n8n-chat-wrapper button[type="submit"]:hover {
        background: #34495e !important;
    }

    /* Typing indicator */
    .n8n-chat-wrapper .chat-typing-indicator {
        color: #6b7280 !important;
    }

    /* Hide toggle button in embedded mode */
    .n8n-chat-wrapper .chat-toggle {
        display: none !important;
    }

    /* Hide the header completely */
    .n8n-chat-wrapper .chat-header,
    .n8n-chat-wrapper [class*="chat-header"] {
        display: none !important;
    }

    /* Hide close button since we have modal close */
    .n8n-chat-wrapper .chat-close-button {
        display: none !important;
    }
</style>
<script src="/js/dist/app/campaigns.min.js"></script>
{{end}}